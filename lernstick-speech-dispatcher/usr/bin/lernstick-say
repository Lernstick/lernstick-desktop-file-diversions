#!/bin/bash

# source config files
# (bash pathname expansion is alphabetically sorded)
for i in /etc/lernstick-say.d/*
do
	. "$i"
done

TIKA_PORT=9998

LOG_FILE=/tmp/lernstick-say.log
echo "" >>$LOG_FILE

# start tika
if ! pgrep -f tika-server >/dev/null
then
	echo "starting tika..." | tee -a $LOG_FILE
	java -jar /usr/share/java/tika-server.jar&
	while ! ss -l | grep ":$TIKA_PORT "
	do
		sleep 0.1
	done
fi

echo "===============================" | tee -a $LOG_FILE
# get the parameters for voice (default voice for the current user) and the text itself
VOICE=$1
echo "voice: $VOICE" | tee -a $LOG_FILE
shift
TEXT="$*"
echo "text:" | tee -a $LOG_FILE
echo "$TEXT" | tee -a $LOG_FILE
echo "-------------------------------" | tee -a $LOG_FILE

# special handling of frequent words (for improving performance while typing)
case $VOICE in
	de-DE)
		FREQUENT_WORDS="german"
		;;
	en-US)
		FREQUENT_WORDS="english"
		;;
	es-ES)
		FREQUENT_WORDS="spanish"
		;;
	fr-FR)
		FREQUENT_WORDS="french"
		;;
	it-IT)
		FREQUENT_WORDS="italian"
		;;
esac
RUN_LANGUAGE_DETECTION="true"
# only search frequent words if text is on one single line
if [ $(echo "$TEXT" | grep -c '$') -eq 1 ]
then
	echo "searching frequent words" | tee -a $LOG_FILE
	if grep -q -s "^$TEXT$" /usr/share/lernstick-speech-dispatcher/${FREQUENT_WORDS}.txt
	then
		RUN_LANGUAGE_DETECTION="false"
		echo "is a frequent word" | tee -a $LOG_FILE
	else
		echo "searching foreign words" | tee -a $LOG_FILE
		FOREIGN=$(grep -s "^$TEXT " /usr/share/lernstick-speech-dispatcher/${FREQUENT_WORDS}_foreign.txt | awk '{ print $NF }')
		if [ -n "$FOREIGN" ]
		then
			echo "detected foreign language: \"$FOREIGN\"" | tee -a $LOG_FILE
			VOICE=$FOREIGN
			RUN_LANGUAGE_DETECTION="false"
		fi
	fi
fi

# TODO:
# For some unknown reason fast typing becomes laggy if we skip frequent word and foreign language detection.
# Therefore the single letter test is not done as first (where we would do it otherwise).
if [ ${#TEXT} -eq 1 ]
then
	RUN_LANGUAGE_DETECTION="false"
fi
echo "run language detection: $RUN_LANGUAGE_DETECTION" | tee -a $LOG_FILE

if [ "$RUN_LANGUAGE_DETECTION" == "true" ]
then
	# save text in temporary file
	TEXT_FILE=/tmp/lernstick-say.txt
	echo "$TEXT" > $TEXT_FILE

	# try to auto-detect the language of the text to speak
	DETECTED_LANGUAGE="$(curl -X PUT --data-binary @$TEXT_FILE http://localhost:$TIKA_PORT/language/stream)"
	rm $TEXT_FILE

	echo "detected language: \"$DETECTED_LANGUAGE\"" | tee -a $LOG_FILE
	case $DETECTED_LANGUAGE in
		de)
			VOICE="de-DE"
			;;
		en)
			VOICE="en-US"
			;;
		es)
			VOICE="es-ES"
			;;
		fr)
			VOICE="fr-FR"
			;;
		it)
			VOICE="it-IT"
			;;
	esac
fi

# tempo adjustments
TEMPO=1
case $VOICE in
	de-DE)
		TEMPO="${TEMPO_DE:-1}"
		;;
	en-US)
		TEMPO="${TEMPO_EN:-1}"
		;;
	es-ES)
		TEMPO="${TEMPO_ES:-1}"
		;;
	fr-FR)
		TEMPO="${TEMPO_FR:-1}"
		;;
	it-IT)
		TEMPO="${TEMPO_IT:-1}"
		;;
esac
echo "tempo: $TEMPO" | tee -a $LOG_FILE

# synthesize wav file
WAV_FILE=/tmp/lernstick-say.wav
PLAY_OPTIONS=""
case $VOICE in
#	en-US)
#		if systemctl is-active --quiet mozilla-tts-en
#		then
#			curl -G --output $WAV_FILE --data-urlencode "text=$TEXT" 'http://localhost:5002/api/tts'
#		else
#			pico2wave -w $WAV_FILE -l $VOICE "<volume level='50'>$TEXT"
#			PLAY_OPTIONS="treble 20 gain -l 6"
#		fi
#		;;
	de-DE)
		pico2wave -w $WAV_FILE -l $VOICE "<volume level='55'>$TEXT"
		PLAY_OPTIONS="treble 20 bass -20"
		;;
	en-US)
		pico2wave -w $WAV_FILE -l $VOICE "<volume level='65'>$TEXT"
		PLAY_OPTIONS="treble 20 bass -20"
		;;
	es-ES)
		pico2wave -w $WAV_FILE -l $VOICE "<volume level='60'>$TEXT"
		PLAY_OPTIONS="treble 20 bass -20"
		;;
	fr-FR)
		pico2wave -w $WAV_FILE -l $VOICE "<volume level='95'>$TEXT"
		PLAY_OPTIONS="treble 20 bass -20"
		;;
	it-IT)
		pico2wave -w $WAV_FILE -l $VOICE "<volume level='75'>$TEXT"
		PLAY_OPTIONS="treble 20 bass -20"
		;;
esac

# play wav file
play -q $WAV_FILE $PLAY_OPTIONS tempo -s "$TEMPO" 2>/dev/null

# cleanup
rm $WAV_FILE
